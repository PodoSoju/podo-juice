# PodoSoju v11.0-rc5 업그레이드 및 개선 계획

> **플랜 위치**: `.do/plans/2026/01/10.rc5-upgrade.md`

## 요약
Wine 11.0-rc5로 업그레이드하고, 창 포커스 문제 해결, 버전 자동화, 아이콘 추출, 방어 코드 추가

## 핵심 원칙
- **멱등성**: 모든 스크립트는 여러 번 실행해도 같은 결과
- **소스 미포함**: Wine 소스는 저장소에 포함하지 않음, Actions에서 다운로드
- **Wine 패치 필수**: 창 identity 보장을 위해 패치 적용 필수

## 사용자 결정사항
- [x] 소스 빌드 선택 (패치 적용 가능) → GitHub Actions
- [x] GPTK 옵셔널 유지 (상업적 프로젝트 대비)
- [x] Wine 패치 우선 (SOJU_EXE_PATH로 창 식별)

---

## Phase 1: Soju 버전업 및 빌드 전략 (3단계)

### 1.1 빌드 전략 - 순차 + 병렬 접근

**Step 1: Gcenx 바이너리 + 패치 (먼저 시도)**
```bash
# Gcenx 빌드 다운로드
curl -fsSL -o wine.tar.xz "https://github.com/Gcenx/macOS_Wine_builds/releases/download/11.0-rc5/wine-staging-11.0-rc5-osx64.tar.xz"

# winemac.drv만 패치 적용하여 교체 시도
# - 소스에서 dlls/winemac.drv만 빌드
# - Gcenx 바이너리의 winemac.drv.so 교체
```
→ 빠름 (5분), 하지만 ABI 불일치 위험

**Step 2: 실패 시 병렬 진행**
| 트랙 | 방식 | 소요 시간 |
|------|------|----------|
| **Track A** | crossover-wine-ci 방식 (MacPorts + Actions) | 1-2시간 |
| **Track B** | Gcenx fork + 패치 PR | 검토 대기 |

→ 두 트랙을 GitHub Actions에서 병렬 실행

**Step 3: 성공한 방식 채택**
- Track A 성공 → 자체 빌드 파이프라인 확보
- Track B 성공 → Gcenx 인프라 활용 (유지보수 용이)

### 1.2 rc5 버전 적용
- [ ] wine-source/wine-11.0-rc5 디렉토리 이미 존재 (확인됨)
- [ ] `VERSION` 파일 생성: `11.0-rc5`
- [ ] `scripts/build-ci.sh`의 `WINE_VERSION` 환경변수에서 VERSION 파일 읽기
- [ ] `scripts/build-source.sh` 신규 생성 (소스 빌드용)

### 1.3 버전 자동화 구조 (소스 미포함)
```
soju/
├── VERSION                    # 단일 버전 소스 (예: 11.0-rc5)
├── patches/                   # 패치만 저장소에 보관
│   └── 0001-winemac-add-window-identifier.patch
├── .github/workflows/
│   └── release.yml           # Wine 소스 다운로드 + 패치 + 빌드
├── Makefile                  # VERSION 파일 참조
└── scripts/
    ├── build-source.sh       # 소스 빌드 (다운로드 → 패치 → 컴파일)
    └── package.sh            # 로컬 패키징 (GPTK 옵셔널)
```

**핵심: Wine 소스는 저장소에 포함하지 않음**
- GitHub Actions에서 빌드 시 Wine 소스 다운로드
- 패치만 저장소에 보관 (`patches/`)
- wine-source/ 디렉토리 삭제 (또는 .gitignore)

### 1.4 GPTK 옵셔널 처리 (이미 구현됨)
- `package.sh:79-86`: D3DMetal이 있으면 포함, 없으면 스킵
- 상업적 배포 시 GPTK 제외 가능

---

## Phase 2: Wine 창 포커스 문제 해결 [핵심]

### 2.1 근본 원인 - PodoSoju만으로는 해결 불가
| 문제 | 원인 | 해결 |
|------|------|------|
| **창 식별 불가** | Wine 창의 identity 보장 안 됨 | **Wine 패치 필수** |
| Wine 창 감지 실패 | NSWorkspace가 Wine 프로세스 미인식 | Wine 패치 후 identifier 사용 |
| 창 제목 없음 | kCGWindowName이 nil인 경우 많음 | identifier로 대체 |
| 포커스 실패 | 어떤 창이 어떤 exe인지 모름 | SOJU_EXE_PATH로 식별 |

**결론: Wine 패치 없이는 창 identity 보장 불가 → 포커스 문제 해결 불가**

### 2.2 해결 전략: Wine 패치 필수

**Step 1: GitHub Actions에서 Wine 소스 빌드**
```yaml
# .github/workflows/release.yml
jobs:
  build:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      # Wine 소스 다운로드 (저장소에 포함하지 않음)
      - name: Download Wine source
        run: |
          WINE_VERSION=$(cat VERSION)
          curl -fsSL -o wine.tar.xz \
            "https://github.com/wine-mirror/wine/archive/refs/tags/wine-${WINE_VERSION}.tar.gz"
          tar -xzf wine.tar.xz

      # 패치 적용
      - name: Apply patches
        run: |
          cd wine-wine-*
          for patch in ../patches/*.patch; do
            patch -p1 < "$patch"
          done

      # 빌드 (약 1-2시간)
      - name: Build Wine
        run: |
          cd wine-wine-*
          ./configure --enable-archs=x86_64
          make -j$(sysctl -n hw.ncpu)

      # 패키징
      - name: Package
        run: ./scripts/build-source.sh
```

**패치 내용 (cocoa_window.m):**
```objc
// 창 생성 시 SOJU_EXE_PATH 환경변수를 NSWindow.identifier로 설정
const char* exePath = getenv("SOJU_EXE_PATH");
if (exePath) {
    NSString* identifier = [NSString stringWithUTF8String:exePath];
    [window setIdentifier:identifier];
} else {
    [window setIdentifier:@"wine-unknown"];
}
```

**Step 2: PodoSoju에서 환경변수 설정**
```swift
// Program.run()에서 환경변수 추가
additionalEnv["SOJU_EXE_PATH"] = self.url.path(percentEncoded: false)
```

**Step 3: identifier 기반 창 포커스**
```swift
// focusRunningProgram()에서 identifier로 창 검색
for window in windowList {
    if window.identifier == programPath {
        // 정확한 창 포커스
    }
}
```

### 2.3 Wine 단일 인스턴스 + 자동 포커스
Wine 앱이 단일 인스턴스 패턴 사용 시:
1. `CreateMutex("MyApp", TRUE)` → 중복 실행 감지
2. `FindWindow("MyAppClass", NULL)` → 기존 창 찾기
3. `SetForegroundWindow(hwnd)` → Wine이 macOS 창 활성화
→ Wine 내부에서 자동 처리 (PodoSoju 개입 불필요)

---

## Phase 3: 인디케이터 정확한 타이밍

### 3.1 현재 문제
- 60초 폴링으로 창 감지 (비효율)
- 창 제목 매칭 실패 시 인디케이터 계속 표시

### 3.2 개선 방안
**파일: `PodoSoju/Views/Workspace/ShortcutView.swift:checkMyWindowOpened()`**

```swift
// 개선된 창 감지 로직
1. SOJU_EXE_PATH로 설정된 identifier 매칭 (가장 정확)
2. Wine PID 소유 창이 1개면 해당 창으로 판단
3. 프로세스 실행 중 + Wine 창 존재 = found
4. 폴링 간격: 1초 → 0.5초 (더 빠른 감지)
```

### 3.3 인디케이터 종료 조건
- [x] Wine 창 identifier 매칭
- [x] 프로세스 종료 감지
- [x] 60초 타임아웃
- [ ] **추가**: Wine 프로세스의 첫 창 생성 감지

---

## Phase 4: 타이틀 정확히 표시

### 4.1 현재 문제
- Wine 창 제목과 PodoSoju 표시 이름 불일치
- ShortcutParser가 .lnk에서 이름 추출하지만 실제 창 제목과 다름

### 4.2 해결 방안
**옵션 A: Wine 창 제목 실시간 동기화**
- CGWindowList에서 kCGWindowName 읽기
- 창 제목 변경 시 PodoSoju UI 업데이트

**옵션 B: .lnk 파일의 실제 이름 사용 (권장)**
- ShortcutParser에서 Windows 리소스 이름 추출
- 한글 이름 정확히 표시

---

## Phase 5: 아이콘 추출 및 표시

### 5.1 현재 상태
- SF Symbol 기반 아이콘만 사용 (iconImage: String)
- ShortcutParser에 iconLocation 필드 있지만 미사용

### 5.2 구현 계획

**Phase 5.1: iconLocation 활용**
```swift
// ShortcutParser에서 이미 추출됨
public struct ParsedShortcut {
    public let iconLocation: String?  // "C:\path\to\app.exe,0"
}
```

**Phase 5.2: PE 파일 아이콘 추출**
1. Wine prefix 경로로 변환: `C:\...` → `~/Library/.../drive_c/...`
2. PE 파일의 .rsrc 섹션에서 RT_ICON 리소스 추출
3. ICO → NSImage 변환

**Phase 5.3: 아이콘 캐싱**
```
~/Library/Caches/com.soju.app/IconCache/
├── [program-id-hash].png
└── ...
```

**Phase 5.4: UI 업데이트**
- DesktopIcon 모델에 iconData: Data? 필드 추가
- ShortcutView에서 Image(nsImage:) 사용

---

## Phase 6: 방어 코드 및 릴리즈 안정화

### 6.1 gh CLI 기반 Actions 추적 및 자동 개선

**워크플로우:**
```bash
# 1. 빌드 트리거 후 추적
gh workflow run release.yml
gh run watch  # 실시간 모니터링

# 2. 실패 시 로그 분석
gh run view [run-id] --log-failed

# 3. 문제 자동 감지 및 수정
# - 다운로드 실패 → 재시도 로직 추가
# - 컴파일 에러 → 패치 수정
# - 테스트 실패 → 로그 분석 후 수정

# 4. 수정 후 재빌드
git push && gh run watch
```

**Makefile에 gh 통합:**
```makefile
# Actions 추적 명령
watch:
    gh run watch

logs:
    gh run view --log-failed

retry:
    gh run rerun --failed
```

### 6.2 멱등성 보장 [필수]
**모든 스크립트는 여러 번 실행해도 같은 결과**

```bash
# 다운로드 - 이미 있으면 스킵
download_if_needed() {
    local url=$1
    local output=$2
    if [ -f "$output" ]; then
        echo "Already exists: $output"
        return 0
    fi
    curl -fSL "$url" -o "$output"
}

# 패치 - 이미 적용되었으면 스킵
apply_patch_idempotent() {
    local patch=$1
    if patch -p1 --dry-run < "$patch" 2>/dev/null; then
        patch -p1 < "$patch"
    else
        echo "Patch already applied or not applicable: $patch"
    fi
}

# 빌드 - 이미 빌드되었으면 스킵
build_if_needed() {
    if [ -f "wine/bin/wine64" ]; then
        echo "Already built"
        return 0
    fi
    ./configure && make -j$(sysctl -n hw.ncpu)
}
```

### 6.3 빌드 실패 방지
**파일: `scripts/build-source.sh`**
```bash
# 다운로드 실패 시 재시도 (멱등)
download_with_retry() {
    local url=$1
    local output=$2
    [ -f "$output" ] && return 0  # 이미 있으면 스킵
    for i in 1 2 3; do
        curl -fSL "$url" -o "$output" && return 0
        echo "Retry $i..."
        sleep 5
    done
    return 1
}

# 파일 무결성 검증
verify_tarball() {
    tar -tzf "$1" > /dev/null 2>&1
}
```

### 6.3 릴리즈 검증
```bash
# Makefile에 검증 단계 추가
release-verify:
    @echo "Verifying release..."
    @test -f dist/Soju-*.tar.gz || (echo "No tarball found" && exit 1)
    @tar -tzf dist/Soju-*.tar.gz > /dev/null || (echo "Invalid tarball" && exit 1)
    @test -f dist/Libraries/SojuVersion.plist || (echo "No version file" && exit 1)
```

### 6.4 GitHub Actions 개선
```yaml
# release.yml 추가
- name: Verify build artifacts
  run: |
    ls -la dist/
    tar -tzf dist/Soju-*.tar.gz | head -20

- name: Upload on failure
  if: failure()
  uses: actions/upload-artifact@v4
  with:
    name: failed-build-logs
    path: |
      *.log
      dist/
```

---

## Phase 7: 라이센스 확인

### 7.1 GPTK 라이센스 (Apple)
- **상태**: 비상업적 목적만 허용
- **제한**: Apple 브랜드 제품에서만 사용, 상업 배포 금지
- **결정 필요**: D3DMetal 사용 여부

### 7.2 현재 Soju 구성
- Wine-Staging: LGPL (자유 배포)
- DXMT: MIT (자유 배포)
- DXVK: zlib (자유 배포)
- CJK Fonts: OFL-1.1 (자유 배포)

---

## 수정 대상 파일

### Soju (Wine 배포판)
| 파일 | 변경 내용 |
|------|----------|
| `VERSION` (신규) | 단일 버전 소스 |
| `.github/workflows/release.yml` | VERSION 파일 참조로 변경 |
| `Makefile` | VERSION 파일 참조, 검증 단계 추가 |
| `scripts/build-ci.sh` | 재시도 로직, 무결성 검증 |
| `patches/0001-winemac-add-window-identifier.patch` | 이미 존재 (적용 필요) |

### PodoSoju App
| 파일 | 변경 내용 |
|------|----------|
| `PodoSojuKit/.../Workspace.swift` | SOJU_EXE_PATH 환경변수 설정, 포커스 로직 개선 |
| `PodoSoju/Views/.../ShortcutView.swift` | 창 감지 로직 개선, 인디케이터 타이밍 |
| `PodoSojuKit/.../ShortcutParser.swift` | iconLocation 활용 |
| `PodoSoju/Models/DesktopIcon.swift` | iconData 필드 추가 |

---

## 검증 계획

### 빌드 검증
```bash
cd soju
make build-local
# 또는 GitHub Actions에서 테스트
```

### 창 포커스 검증
1. PodoSoju에서 Windows 앱 실행
2. 창이 자동으로 포커스되는지 확인
3. 중복 실행 시 기존 창이 포커스되는지 확인

### 인디케이터 검증
1. 앱 실행 시 인디케이터 표시
2. 창 생성 즉시 인디케이터 종료
3. 60초 타임아웃 동작 확인

---

## 결정 완료

- [x] **소스 빌드 방식**: GitHub Actions 소스 빌드
- [x] **GPTK**: 옵셔널 (상업적 배포 대비)
- [x] **포커스 해결**: Wine 패치 필수 (SOJU_EXE_PATH)

---

## 실행 순서 요약

1. **소스 빌드 환경 설정** → Wine 11.0-rc5 + 패치 적용
2. **gh CLI로 Actions 추적** → 빌드 성공 확인
3. **PodoSoju 환경변수 설정** → SOJU_EXE_PATH 전달
4. **창 포커스 테스트** → identifier 기반 포커스 확인
5. **인디케이터/타이틀/아이콘** → 순차 개선
6. **릴리즈** → v11.0-rc5
